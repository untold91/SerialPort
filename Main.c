/**************************************************************************************************************************/
/* C SOURCE FILE                                                                                                          */
/**************************************************************************************************************************/
/* Project    : Serial Port
 * File Name  : Main.c
 * Author     : Dhanush.K (dhanushsandy91@gmail.com)
 * Date       : 30/11/2021
 *
 * Revised on : 30/11/2021
 * Version    : V0.0.1
 *
 * Brief      : Serial Port Communication (RS232) for UNIX envernment.
 *
 * Reference  : -> https://www.cmrr.umn.edu/~strupp/serial.html#basics
 *
 */
/**************************************************************************************************************************/
/* Licence    : MIT
 * Copyright (c) 2021 Dhanush.K
 */
/**************************************************************************************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>

#include <stdbool.h>
#include <string.h>
#include <unistd.h>

#include "./src/serialPort.h"

/**************************************************************************************************************************/
/* Macro Declarations                                                                                                     */
/**************************************************************************************************************************/

/**************************************************************************************************************************/
/* Typedef, Enums, Structures and Union Declarations                                                                      */
/**************************************************************************************************************************/

/**************************************************************************************************************************/
/* Global Variable Declarations                                                                                           */
/**************************************************************************************************************************/
/**
 * @brief Mutual exclusion for our threads
 *
 */
pthread_mutex_t mutexsum = PTHREAD_MUTEX_INITIALIZER;

/**
 * @brief Program Exit Status Flag
 * 
 */
int done = false;

/**************************************************************************************************************************/
/* Function Declarations                                                                                                  */
/**************************************************************************************************************************/
void SerialRead(void *argv);
void SerialWrite(void *argv);

/**************************************************************************************************************************/
/* Main Program                                                                                                           */
/**************************************************************************************************************************/
int main(int argc, char **argv)
{
    printf("--------------------------------------------\n");
    printf("          Serial Port Application\n");
    printf("--------------------------------------------\n");

    char buffer[MAX_BUFF];
    int port0 = init_serialPort(argv[2], atoi(argv[1]));

    pthread_t threads[2];
    pthread_attr_t attr;

    pthread_attr_init(&attr);
    pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_JOINABLE);

    pthread_create(&threads[0], &attr, (void *)&SerialRead, (void *)&port0);

    while (!done)
    {
        bzero(buffer, strlen(buffer));
        scanf("%s", buffer);
        printf("Sending >> ");
        write_serialPort(port0, buffer);
        sleep(1);
    }

    return 0;
}

void SerialRead(void *argv)
{
    int port = *((int *)argv);
    while (1)
    {
        BYTE data = read_serialPort(port);

        printf("%c", data);
    }
}

/**************************************************************************************************************************/
/* Function Definations                                                                                                   */
/**************************************************************************************************************************/

/**************************************************************************************************************************/
/* End of File                                                                                                            */
/**************************************************************************************************************************/